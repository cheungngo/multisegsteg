% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/ss.R
\name{fit_for_n_thresholds}
\alias{fit_for_n_thresholds}
\title{Fit a Segmented or Stegmented Model for a Single Number of Thresholds}
\usage{
fit_for_n_thresholds(
  n_thresholds,
  formula.1,
  formula.2,
  family,
  data,
  lb.quantile,
  ub.quantile,
  grid.search.max,
  cluster_var,
  verbose,
  model_type,
  ...
)
}
\arguments{
\item{n_thresholds}{An integer specifying the number of thresholds to fit.}

\item{formula.1}{A formula specifying the outcome and base covariates (e.g., \code{y ~ x1 + x2}).}

\item{formula.2}{A formula specifying the change point variable (e.g., \code{~ z}).}

\item{family}{A character string specifying the family of the model. Must be either \code{"gaussian"} or \code{"binomial"}.}

\item{data}{A data frame containing the variables specified in the formulas.}

\item{lb.quantile}{A numeric value between 0 and 1 specifying the lower bound quantile for threshold candidates.}

\item{ub.quantile}{A numeric value between 0 and 1 specifying the upper bound quantile for threshold candidates.}

\item{grid.search.max}{An integer specifying the maximum number of threshold candidates to consider.
Set to 20 when \code{n_thresholds = 1}.}

\item{cluster_var}{Optional. A character string specifying the name of the clustering variable for computing cluster-robust standard errors.}

\item{verbose}{Logical. If \code{TRUE}, prints detailed output for each threshold combination.}

\item{model_type}{A character string specifying the type of model to fit. Must be either \code{"segmented"} or \code{"stegmented"}.
\itemize{
\item \code{"segmented"}: Includes only segmented terms \code{(x - e_i)+}.
\item \code{"stegmented"}: Includes both step terms \code{I(x > e_i)} and segmented terms \code{(x - e_i)+}.
}}

\item{...}{Additional arguments passed to the fitting functions (\code{lm} or \code{glm}).}
}
\value{
A list containing the following components:
\itemize{
\item \code{n_thresholds_requested}: The number of thresholds requested.
\item \code{n_thresholds_used}: The number of thresholds actually used (may be less than requested if data constraints apply).
\item \code{thresholds}: The best thresholds selected based on log-likelihood.
\item \code{fit}: The fitted model object (\code{lm} or \code{glm}).
\item \code{loglik}: The log-likelihood of the best model.
\item \code{all_logliks}: A vector of log-likelihoods for all threshold combinations evaluated.
\item \code{all_combinations}: A matrix of all threshold combinations evaluated.
\item \code{vcov_cluster}: The cluster-robust variance-covariance matrix, if \code{cluster_var} is specified.
\item \code{se_cluster}: The cluster-robust standard errors, if \code{cluster_var} is specified.
}
}
\description{
This internal helper function fits a segmented or stegmented model for a specified number of thresholds,
selecting the best threshold combination via grid search over quantiles of the change point variable.
It supports Gaussian and binomial families and optionally computes cluster-robust standard errors.
}
\details{
This function is called by \code{\link{multi_ss}} to fit models for a single number of thresholds.
It performs a grid search over combinations of thresholds within the specified quantile range of the change point variable,
selecting the combination that maximizes the log-likelihood. If the requested number of thresholds exceeds the number of
unique thresholds available, it reduces the number used and issues a warning.
}
\note{
The \code{sandwich} package is required for computing cluster-robust standard errors and must be installed.
This function is intended for internal use by \code{\link{multi_ss}}.
}
\keyword{internal}
