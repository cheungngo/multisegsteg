% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/ss.R
\name{multi_ss}
\alias{multi_ss}
\title{Fit Segmented or Stegmented Models with Multiple Thresholds}
\usage{
multi_ss(
  formula.1,
  formula.2,
  family,
  data,
  n_thresholds = 1,
  lb.quantile = 0.05,
  ub.quantile = 0.95,
  grid.search.max = Inf,
  cluster_var = NULL,
  verbose = FALSE,
  model_type = "segmented",
  ...
)
}
\arguments{
\item{formula.1}{A formula specifying the outcome and base covariates (e.g., \code{y ~ x1 + x2}).}

\item{formula.2}{A formula specifying the change point variable (e.g., \code{~ z}).}

\item{family}{A character string specifying the family of the model. Must be either \code{"gaussian"} or \code{"binomial"}.}

\item{data}{A data frame containing the variables specified in the formulas.}

\item{n_thresholds}{An integer or vector of integers specifying the number(s) of thresholds to fit.
\itemize{
\item If a single integer, fits models for 1 up to that number (e.g., \code{3} fits for 1, 2, and 3 thresholds).
\item If a vector, fits models for each specified number (e.g., \code{c(1, 3)} fits for 1 and 3 thresholds).
}}

\item{lb.quantile}{A numeric value between 0 and 1 specifying the lower bound quantile for threshold candidates. Default is 0.05.}

\item{ub.quantile}{A numeric value between 0 and 1 specifying the upper bound quantile for threshold candidates. Default is 0.95.}

\item{grid.search.max}{An integer specifying the maximum number of threshold candidates to consider. Default is \code{Inf}, meaning all unique quantiles are used.
\itemize{
\item For \code{n_thresholds = 1}, \code{grid.search.max} is set to 20.
}}

\item{cluster_var}{Optional. A character string specifying the name of the clustering variable for computing cluster-robust standard errors.}

\item{verbose}{Logical. If \code{TRUE}, prints detailed output for each threshold combination. Default is \code{FALSE}.}

\item{model_type}{A character string specifying the type of model to fit. Must be either \code{"segmented"} or \code{"stegmented"}.
\itemize{
\item \code{"segmented"}: Includes only segmented terms \code{(x - e_i)+}.
\item \code{"stegmented"}: Includes both step terms \code{I(x > e_i)} and segmented terms \code{(x - e_i)+}.
}}

\item{...}{Additional arguments passed to the fitting functions (\code{lm} or \code{glm}).}
}
\value{
A list of model results, where each element corresponds to a specific number of thresholds.
The list is named by the number of thresholds requested (e.g., "1", "2", etc.). Each element contains:
\itemize{
\item \code{n_thresholds_requested}: The number of thresholds requested for this model.
\item \code{n_thresholds_used}: The number of thresholds actually used in the model (may be less than requested if data constraints apply).
\item \code{thresholds}: The best thresholds selected based on log-likelihood.
\item \code{fit}: The fitted model object (\code{lm} or \code{glm}).
\item \code{loglik}: The log-likelihood of the best model.
\item \code{all_logliks}: A vector of log-likelihoods for all threshold combinations evaluated.
\item \code{all_combinations}: A matrix of all threshold combinations evaluated.
\item \code{vcov_cluster}: The cluster-robust variance-covariance matrix, if \code{cluster_var} is specified.
\item \code{se_cluster}: The cluster-robust standard errors, if \code{cluster_var} is specified.
}
}
\description{
This function fits either a segmented or a "stegmented" model (a combination of step and segmented terms)
for multiple numbers of thresholds, selecting the best thresholds via grid search over quantiles of the
change point variable. It supports both Gaussian and binomial families and optionally computes
cluster-robust standard errors.
}
\details{
The function performs a grid search over combinations of thresholds within the specified quantile range of the change point variable.
For each number of thresholds, it selects the combination that maximizes the log-likelihood.
If the requested number of thresholds exceeds the number of unique thresholds available, the function reduces the number of thresholds
used and issues a warning. Only results where the number of thresholds used equals the number requested are included in the output.
}
\note{
The \code{sandwich} package is required for computing cluster-robust standard errors and must be installed.
}
\examples{
# Fit a segmented model for 1 to 3 thresholds
result <- multiss(formula.1 = y ~ x1 + x2, formula.2 = ~ z, family = "gaussian", data = mydata, n_thresholds = 3)

# Fit a stegmented model for specific numbers of thresholds
result <- multiss(formula.1 = y ~ x1 + x2, formula.2 = ~ z, family = "binomial", data = mydata, n_thresholds = c(1, 3), model_type = "stegmented")

}
